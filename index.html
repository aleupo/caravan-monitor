<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Bluetooth Notification Example</title>
</head>
<body>
    <h1>Web Bluetooth: Notify Characteristic</h1>
    <button id="connectButton">Connect and Subscribe</button>
    <p id="output"></p>

    <script>
        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                // Definiere die UUID der Notify Characteristic
                const serviceUuid = '2d37d6fb-e0f0-438e-8000-81d083939a53';  // UUID für den Service
                const characteristicUuid = '85a00908-8fbb-4c40-bdc6-a37c59ea89ac';  // UUID für die Notify Characteristic

                // Fordere den Benutzer auf, ein BLE-Gerät auszuwählen
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [serviceUuid]
                });

                // Verbinde dich mit dem Gerät
                const server = await device.gatt.connect();

                // Finde den Primary Service
                const service = await server.getPrimaryService(serviceUuid);

                // Finde die Notify Characteristic
                const characteristic = await service.getCharacteristic(characteristicUuid);

                // Benachrichtigungen aktivieren
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                // Output-Text aktualisieren
                document.getElementById('output').textContent = 'Subscribed to notifications...';
            } catch (error) {
                console.error('Es gab einen Fehler:', error);
                document.getElementById('output').textContent = 'Fehler: ' + error;
            }
        });

        // Callback-Funktion für Benachrichtigungen
        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const decodedValue = decoder.decode(value);

            // Zeige den Wert auf der Webseite an
            document.getElementById('output').textContent = `Notification: ${decodedValue}`;

            // Prüfe, ob die Notifications-API unterstützt wird und zeige eine Web-Benachrichtigung an
            if (Notification.permission === "granted") {
                new Notification("BLE Notification", {
                    body: decodedValue
                });
            }
        }

        // Frage nach Berechtigung für Web Notifications
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
